<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€™çœŸæ˜¯ä¸€å€‹æ­£ç¶“çš„ç†è²¡ç¶²ç«™ - å€‹äººè²¡å‹™ç®¡ç†åŠ©æ‰‹</title>

    <!-- Chart.js + datalabels (ç”¨æ–¼åœ“é¤…åœ–ç™¾åˆ†æ¯”) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
        /* ========== åŸå§‹èˆ‡æ–°ä¸»é¡Œæ¨£å¼ ========== */
        :root {
            --primary: #232946;
            --secondary: #eebbc3;
            --accent: #9eb1e3;
            --button: #eebbc3;
            --light: #feffff;
            --dark: #333e60;
            --highlight: #929bca;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --bg: linear-gradient(135deg, var(--primary), var(--dark));
            --text: rgb(225, 225, 225);
            --card-bg: rgba(255,255,255,0.08);
            --currency-symbol: 'NT$';
        }

        /* äº®è‰²ä¸»é¡Œï¼ˆä½ æä¾›çš„é…è‰²ï¼‰ */
        :root[data-theme="light"] {
            --bg: #faeee7; /* Background */
            --text: #33272a; /* Headline / text */
            --muted: #594a4e; /* paragraph */
            --button: #ff8ba7;
            --button-text: #33272a;
            --illustration-stroke: #33272a;
            --main: #fffffe;
            --highlight: #ff8ba7;
            --secondary-color: #ffc6c7;
            --tertiary: #c3f0ca;
            --card-bg: rgba(255,255,255,1);
            --currency-symbol: 'NT$';
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html, body { height: 100%; }
        body {
            background: var(--bg);
            color: var(--text);
            height: 100vh; /* ç¢ºä¿é«˜åº¦å¡«æ»¿ */
            width: 100vw;  /* ç¢ºä¿å¯¬åº¦å¡«æ»¿ */
            margin: 0;     /* ç§»é™¤é‚Šè· */
            padding: 0;    /* â˜… é—œéµï¼šç§»é™¤åŸæœ¬çš„ 20px ç•™ç™½ */
            display: flex;
            overflow: hidden; /* é˜²æ­¢æ•´å€‹ç¶²é å‡ºç¾é›™é‡æ²è»¸ */
        }

        .app-container {
            width: 100%;       /* â˜… å¯¬åº¦ä½”æ»¿ 100% */
            height: 100vh;     /* â˜… é«˜åº¦ä½”æ»¿è¢å¹•é«˜åº¦ */
            max-width: none;   /* â˜… ç§»é™¤ 1200px çš„é™åˆ¶ */
            border-radius: 0;  /* â˜… ç§»é™¤åœ“è§’ï¼Œè®Šç›´è§’ */
            box-shadow: none;  /* â˜… ç§»é™¤é™°å½± (å› ç‚ºå·²ç¶“æ²’æœ‰é‚Šç•Œäº†) */
            background: transparent;
            display: flex;
            overflow: hidden;  /* å…§éƒ¨å…§å®¹æº¢å‡ºæ™‚è‡ªå·±è™•ç† */
        }

        /* ---------- Sidebar ---------- */
        .sidebar {
            width: 280px;      /* å¯ä»¥ç¨å¾®çª„ä¸€é»ï¼Œçœ‹èµ·ä¾†æ›´ç²¾ç·» */
            height: 100%;      /* é«˜åº¦å¡«æ»¿ */
            padding: 24px;
            background: rgba(0,0,0,0.05); /* çµ¦å®ƒä¸€é»é»åº•è‰²å€éš” */
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;  /* å…§å®¹å¤šæ™‚å¯æ²å‹• */
            border-right: 1px solid rgba(0,0,0,0.1); /* åŠ ä¸€æ¢ç´°ç·šå€éš”å³é‚Š */
        }

        /* â˜… ç¾åŒ–æ²è»¸æ¨£å¼ (è®“æ²è»¸è®Šç´°ã€è®Šé€æ˜ï¼Œæ¯”è¼ƒå¥½çœ‹) */
        .sidebar::-webkit-scrollbar {
            width: 6px; /* æ²è»¸å¯¬åº¦ */
        }
        .sidebar::-webkit-scrollbar-track {
            background: transparent; /* è»Œé“é€æ˜ */
        }
        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2); /* æ²è»¸æœ¬é«”åŠé€æ˜ç™½ */
            border-radius: 10px; /* åœ“è§’ */
        }
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4); /* æ»‘é¼ ç§»ä¸Šå»è®Šäº® */
        }

        :root[data-theme="light"] .sidebar { background: transparent; }
        .logo h1 { font-size: 1.6rem; margin-bottom: 4px; color: var(--text); }
        .logo p { color: var(--muted); font-size: 0.9rem; }

        .auth-forms { background: var(--card-bg); padding: 14px; border-radius: 10px; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display:block; margin-bottom:6px; color:var(--muted); font-size:0.9rem; }
        .form-group input, .form-group select { width:100%; padding:8px; border-radius:6px; border:1px solid rgba(0,0,0,0.06); }

        .btn { padding:10px; border-radius:8px; border:none; cursor:pointer; width:100%; font-weight:600; }
        .btn-primary { background: var(--button, #3498db); color: var(--button-text, white); }
        .btn-secondary { background: transparent; border:1px solid rgba(255,255,255,0.12); color: var(--text); }

        .user-info { display:none; background:var(--card-bg); padding:12px; border-radius:8px; text-align:center; }
        .user-info.active { display:block; }

        .nav-menu { list-style:none; margin-top:8px; display:none; gap:8px; }
        .nav-menu.active { display:flex; flex-direction:column; }
        .nav-link { display:flex; align-items:center; gap:10px; padding:10px; border-radius:8px; color:var(--text); text-decoration:none; cursor:pointer; }
        .nav-link.active, .nav-link:hover { background: rgba(255,255,255,0.06); }

        /* ---------- Main content ---------- */
        .main-content { flex:1; padding:22px; overflow:auto; background:transparent; }
        .welcome-message { background: var(--card-bg); padding:24px; border-radius:12px; text-align:center; }
        .content-section { display:none; }
        .content-section.active { display:block; }

        .section-header h2{ font-size:1.6rem; margin-bottom:6px; color:var(--text); }
        .section-header p{ color:var(--muted); margin-bottom:12px; }

        .stats-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-bottom:16px; }
        .stat-card { background: var(--card-bg); padding:14px; border-radius:10px; }
        .stat-card h3 { font-size:0.9rem; color:var(--muted); margin-bottom:8px; }
        .stat-card .amount { font-size:1.3rem; font-weight:700; color:var(--text); }

        .chart-container { background:var(--card-bg); padding:12px; border-radius:10px; height:260px; margin-bottom:12px; }
        .transaction-form { background:var(--card-bg); padding:12px; border-radius:10px; margin-bottom:12px; }
        .form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:8px; margin-bottom:8px; }
        .transaction-list { max-height:300px; overflow:auto; background:var(--card-bg); border-radius:10px; padding:8px; }
        .transaction-item { display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid rgba(0,0,0,0.06); }
        .transaction-amount.income { color:var(--success); }
        .transaction-amount.expense { color:var(--danger); }
        .delete-btn { background:none; border:none; color:rgba(0,0,0,0.5); cursor:pointer; font-size:1.1rem; }

        .settings-option { background:var(--card-bg); padding:12px; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }

        .goal-item { background:var(--card-bg); padding:10px; border-radius:8px; margin-bottom:8px; }
        .progress { height:10px; background:rgba(0,0,0,0.06); border-radius:6px; overflow:hidden; margin-top:8px; }
        .progress-bar { height:100%; background:var(--highlight); width:0%; }

        @media (max-width:900px){
            .sidebar{ width:100%; display:flex; flex-direction:row; gap:10px; flex-wrap:wrap; }
            .main-content{ padding:12px; }
            .app-container{ flex-direction:column; height:auto; }
        }

        /* ========== é‡‘èåœ–è¡¨å°ˆç”¨æ¨£å¼ (è²¼åœ¨ style çµæŸå‰) ========== */
        .market-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr; /* å…©æ¬„æ’åˆ— */
            gap: 20px;
            width: 100%;
        }
        .span-full { grid-column: span 2; } /* è·¨æ¬„ä½å¤§åœ– */
        .tv-card {
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            padding: 0; /* TradingView ä¸éœ€è¦å…§è·ï¼Œè¨­ç‚º 0 */
            min-height: 400px; /* é è¨­é«˜åº¦ */
        }
        /* æ‰‹æ©Ÿç‰ˆæ”¹æˆå–®æ¬„ */
        @media (max-width: 900px) {
            .market-dashboard { grid-template-columns: 1fr; }
            .span-full { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ========== å·¦å´å´æ¬„ï¼šä¿ç•™åŸæœ¬ç™»å…¥è¡¨å–® (ä¸è®Š) ========== -->
        <div class="sidebar">
            <div class="logo"style="text-align: center;">
                <h1>é€™æ˜¯ä¸€å€‹æ­£ç¶“çš„<br>ç†è²¡ç¶²ç«™</h1>
                <p>æ‚¨å”¯ä¸€éœ€è¦çš„æ™ºèƒ½è´¢åŠ¡ç®¡ç†åŠ©æ‰‹<br>å‰å¤§çš„è—è¡“å®¶â€”â€”è”¡å¦¤æ—‹æ‰€è£½</p>
            </div>

            <!-- é€™è£¡ä¿ç•™ä½ åŸæœ¬çš„ auth ç›’å­åŠç™»å…¥è¡¨å–®ï¼ŒID ä¿æŒä¸è®Šä»¥ç¢ºä¿ register.html çš„é€£å‹• -->
            <div class="auth-forms" id="auth-forms">
                <!-- # ä¸éœ€è¦ï¼šæ›¿æ›åŸæœ¬ç™»å…¥è¡¨å–®ï¼ˆæ­¤è™•ä¿ç•™åŸç™»å…¥é‚è¼¯ä»¥ç›¸å®¹ register.htmlï¼‰ -->
                 <!--
                # åŸå§‹ç™»å…¥è¡¨å–®ä¿ç•™å¦‚ä¸‹ï¼ˆæ¯ä¸€è¡Œå‰é¢éƒ½åŠ ä¸Š # ä½œç‚ºä½ è¦æ±‚çš„æ¨™è¨˜ï¼‰
                # <div class="auth-form active" id="login-form">
                #     <h3>ç”¨æˆ¶ç™»éŒ„</h3>
                #     <div class="form-group">
                #         <label for="username">ç”¨æˆ¶å</label>
                #         <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                #     </div>
                #     <div class="form-group">
                #         <label for="password">å¯†ç¢¼</label>
                #         <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                #     </div>
                #     <button class="btn btn-primary" id="login-btn">ç™»é™¸</button>
                #     <div class="auth-switch">
                #         é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ<a href="register.html" target="_blank" id="show-register">ç«‹å³è¨»å†Š</a>
                #     </div>
                # </div>
                -->

                <!-- æ­£å¼ä¿ç•™ï¼ˆHTML è¨»è§£ç‰ˆï¼Œç€è¦½å™¨æœƒè§£æé€™å€‹å€å¡Šï¼‰ -->
    
                <div class="auth-form active" id="login-form">
                    <h3>ç”¨æˆ¶ç™»éŒ„</h3>
                    <div class="form-group">
                        <label for="username">ç”¨æˆ¶å</label>
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label for="password">å¯†ç¢¼</label>
                        <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <button class="btn btn-primary" id="login-btn">ç™»é™¸</button>
                    <div class="auth-switch">
                        é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ<a href="register.html" target="_blank" id="show-register">ç«‹å³è¨»å†Š</a>
                    </div>
                </div>
                
            </div>

            <!-- å·²ç™»å…¥å¾Œé¡¯ç¤ºçš„ä½¿ç”¨è€…è³‡è¨Š -->
            <div class="user-info" id="user-info">
                <h3 id="user-greeting">æ­¡è¿ï¼Œç”¨æˆ¶ï¼</h3>
                <p id="user-email">user@example.com</p>
                <button class="btn btn-secondary" id="logout-btn">é€€å‡ºç™»å…¥</button>
            </div>

            <!-- å´é‚Šå°èˆªï¼ˆç™»å…¥å¾Œé¡¯ç¤ºï¼‰ -->
            <ul class="nav-menu" id="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-target="overview">
                        <i>ğŸ“Š</i> è²¡å‹™ç¸½è¦½
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="transactions">
                        <i>ğŸ’°</i> è¨˜å¸³ç®¡ç†
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="analytics">
                        <i>ğŸ“ˆ</i> çµ±è¨ˆåˆ†æ
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="budgets">
                        <i>ğŸ·ï¸</i> é ç®—è¦åŠƒ
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="goals">
                        <i>ğŸ¯</i> ç›®æ¨™ç®¡ç†
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="recurring">
                        <i>ğŸ”</i> é€±æœŸæ€§äº¤æ˜“
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="categories">
                        <i>ğŸ·ï¸</i> è‡ªè¨‚åˆ†é¡
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="market-chart">
                        <i>ğŸ“‰</i> é‡‘èåœ–è¡¨
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="settings">
                        <i>âš™ï¸</i> ç³»çµ±è¨­ç½®
                    </a>
                </li>
            </ul>
        </div>

        <!-- ---------- ä¸»å…§å®¹å€ï¼ˆç™»å…¥å‰é¡¯ç¤ºæ­¡è¿ï¼Œç™»å…¥å¾Œåˆ‡æ›é ç±¤ï¼‰ ---------- -->
        <div class="main-content">
            <!-- æ­¡è¿ï¼ˆæœªç™»å…¥ï¼‰ -->
            <div class="welcome-message active" id="welcome-message">
                <h2>æ­¡è¿ä½¿ç”¨é€™å€‹æ­£ç¶“çš„ç†è²¡ç¶²ç«™</h2>
                <p>é–‹å§‹ç®¡ç†æ‚¨çš„è²¡å‹™ã€‚æˆ‘å€‘æä¾›è¨˜å¸³ã€é ç®—ã€ç›®æ¨™èˆ‡é€±æœŸæ€§äº¤æ˜“ç­‰åŠŸèƒ½ã€‚</p>
            </div>

            <!-- è²¡å‹™ç¸½è¦½ -->
            <div class="content-section" id="overview">
                <div class="section-header">
                    <h2>è²¡å‹™ç¸½è¦½</h2>
                    <p>ä½ çš„æ”¶æ”¯æµé‡åœ–</p>
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <h3>ç¸½æ”¶å…¥</h3>
                        <div class="amount" id="total-income">NT$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>ç¸½æ”¯å‡º</h3>
                        <div class="amount" id="total-expense">NT$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>ç•¶å‰é¤˜é¡</h3>
                        <div class="amount" id="balance">NT$0.00</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="flow-chart"></canvas>
                    <!-- flow-chart æœƒæ ¹æ“šä½¿ç”¨è€…çš„ transactions å‹•æ…‹ç¹ªè£½ï¼›è‹¥ç„¡äº¤æ˜“å‰‡é¡¯ç¤ºç©ºæˆ– 0 -->
                </div>

                <div class="section-header"><h3>æœ€è¿‘äº¤æ˜“</h3></div>
                <div class="transaction-list" id="overview-transactions"></div>
            </div>

            <!-- è¨˜å¸³ç®¡ç† -->
            <div class="content-section" id="transactions">
                <div class="section-header">
                    <h2>è¨˜å¸³ç®¡ç†</h2>
                    <p>æ–°å¢æ”¶å…¥æˆ–æ”¯å‡ºï¼Œç³»çµ±æœƒå„²å­˜è‡³è©²ä½¿ç”¨è€…å¸³è™Ÿ (localStorage ä¸­çš„ users[username].transactions)</p>
                </div>

                <div class="transaction-form">
                    <h3>æ·»åŠ æ–°ç´€éŒ„</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="type">é¡å‹</label>
                            <select id="type">
                                <option value="income">æ”¶å…¥</option>
                                <option value="expense">æ”¯å‡º</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="amount">é‡‘é¡</label>
                            <input type="number" id="amount" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="category">åˆ†é¡ <small style="color:var(--muted)">(å¯æ–¼è‡ªè¨‚åˆ†é¡ä¸­æ–°å¢)</small></label>
                            <select id="category"></select>
                        </div>

                        <div class="form-group">
                            <label for="date">æ—¥æœŸ</label>
                            <input type="date" id="date">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">æè¿°</label>
                        <input type="text" id="description" placeholder="ç°¡è¦èªªæ˜">
                    </div>

                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button class="btn btn-primary" id="add-transaction">æ·»åŠ ç´€éŒ„</button>
                        <button class="btn btn-secondary small" id="export-csv">åŒ¯å‡º CSV</button>
                    </div>
                </div>

                <div class="section-header"><h3>æ‰€æœ‰äº¤æ˜“ç´€éŒ„</h3></div>
                <div class="transaction-list" id="all-transactions"></div>
            </div>

            <!-- çµ±è¨ˆåˆ†æ -->
            <div class="content-section" id="analytics">
                <div class="section-header">
                    <h2>çµ±è¨ˆåˆ†æ</h2>
                    <p>åœ–è¡¨å®Œå…¨æ ¹æ“šä½¿ç”¨è€…çš„å¯¦éš›äº¤æ˜“è³‡æ–™ç”¢ç”Ÿ</p>
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <h3>æœ¬æœˆæ”¯å‡º</h3>
                        <div class="amount" id="month-expense">NT$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>æœ¬æœˆæ”¶å…¥</h3>
                        <div class="amount" id="month-income">NT$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>æœ€å¤§æ”¯å‡ºé¡åˆ¥</h3>
                        <div class="amount" id="top-category">-</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="analytics-chart"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="category-chart"></canvas>
                </div>
            </div>

            <!-- é ç®—è¦åŠƒ -->
            <div class="content-section" id="budgets">
                <div class="section-header"><h2>é ç®—è¦åŠƒ</h2><p>ç‚ºæ¯å€‹æ”¯å‡ºé¡åˆ¥è¨­å®šæœˆé ç®—ï¼Œç³»çµ±æœƒç›£æ§ä½¿ç”¨æƒ…æ³ä¸¦åœ¨æ¥è¿‘/è¶…éæ™‚æé†’</p></div>

                <div class="stat-card" style="margin-bottom:10px">
                    <h3>è¨­å®šé¡åˆ¥æœˆé ç®—</h3>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <select id="budget-category"></select>
                        <input id="budget-amount" type="number" placeholder="æœˆé ç®—" />
                        <button class="btn small" id="set-budget" style="background:var(--highlight);color:var(--button-text)">è¨­å®š</button>
                    </div>
                </div>

                <div id="budgets-list"></div>
            </div>

            <!-- ç›®æ¨™ç®¡ç† -->
            <div class="content-section" id="goals">
                <div class="section-header"><h2>ç›®æ¨™ç®¡ç†</h2><p>è¨­å®šå„²è“„ç›®æ¨™ä¸¦è¿½è¹¤é€²åº¦</p></div>

                <div class="stat-card" style="margin-bottom:10px">
                    <h3>æ–°å¢å„²è“„ç›®æ¨™</h3>
                    <div style="display:grid;gap:8px;margin-top:8px">
                        <input id="goal-name" placeholder="ç›®æ¨™åç¨± (ä¾‹ï¼šæ—…éŠåŸºé‡‘)" />
                        <input id="goal-amount" type="number" placeholder="ç›®æ¨™é‡‘é¡" />
                        <input id="goal-deadline" type="date" />
                        <button class="btn small" id="add-goal" style="background:var(--highlight);color:var(--button-text)">æ–°å¢ç›®æ¨™</button>
                    </div>
                </div>

                <div id="goals-list"></div>
            </div>

            <!-- é€±æœŸæ€§äº¤æ˜“ -->
            <div class="content-section" id="recurring">
                <div class="section-header"><h2>é€±æœŸæ€§äº¤æ˜“</h2><p>è¨­å®šå›ºå®šæ”¶å…¥æˆ–æ”¯å‡ºï¼Œç³»çµ±æ¯æœˆè‡ªå‹•ç”¢ç”Ÿè¨˜éŒ„</p></div>

                <div class="stat-card" style="margin-bottom:10px">
                    <h3>æ–°å¢é€±æœŸäº¤æ˜“</h3>
                    <div style="display:grid;gap:8px;margin-top:8px">
                        <select id="rec-type">
                            <option value="income">æ”¶å…¥</option>
                            <option value="expense">æ”¯å‡º</option>
                        </select>
                        <input id="rec-amount" type="number" placeholder="é‡‘é¡" />
                        <select id="rec-category"></select>
                        <input id="rec-day" type="number" min="1" max="28" placeholder="æ¯æœˆç¬¬å¹¾æ—¥ (1-28)" />
                        <button class="btn small" id="add-recurring" style="background:var(--highlight);color:var(--button-text)">æ–°å¢é€±æœŸ</button>
                    </div>
                </div>

                <div id="recurring-list"></div>
            </div>

            <!-- è‡ªè¨‚åˆ†é¡ -->
            <div class="content-section" id="categories">
                <div class="section-header"><h2>è‡ªè¨‚åˆ†é¡</h2><p>æ–°å¢ / åˆªé™¤è¨˜å¸³åˆ†é¡</p></div>

                <div class="stat-card" style="margin-bottom:10px">
                    <h3>æ–°å¢åˆ†é¡</h3>
                    <div style="display:flex;gap:8px">
                        <input id="new-category" placeholder="æ–°å¢åˆ†é¡åç¨±" />
                        <button class="btn small" id="add-category" style="background:var(--secondary-color);color:var(--text)">æ–°å¢</button>
                    </div>
                    <div id="categories-list" style="margin-top:8px"></div>
                </div>
            </div>

            <div class="content-section" id="market-chart">
                <div class="section-header">
                    <h2>é‡‘èåœ–è¡¨</h2>
                    <p>å³æ™‚å…¨çƒå¸‚å ´æ•¸æ“šèˆ‡æŠ•è³‡è¶¨å‹¢</p>
                </div>

                <div class="tv-card" style="margin-bottom: 20px; min-height: 80px;">
                        <div id="tv-ticker-tape"></div>
                    </div>

                    <div class="market-dashboard">
                        
                        <div class="tv-card span-full" style="height: 600px;">
                            <div id="tv-advanced-chart" style="height:100%;width:100%;"></div>
                        </div>

                        <div class="tv-card span-full" style="height: 600px;">
                            <div id="tv-stock-heatmap" style="height:100%;width:100%;"></div>
                        </div>

                        <div class="tv-card" style="height: 600px;">
                            <div id="tv-market-quotes" style="height:100%;width:100%;"></div>
                        </div>

                        <div class="tv-card" style="height: 600px;">
                            <div id="tv-timeline" style="height:100%;width:100%;"></div>
                        </div>
        
    </div>

            </div>
            <script>
            (function() {
                // 1. è·‘é¦¬ç‡ˆ
                const tickerContainer = document.getElementById("tv-ticker-tape");
                if (tickerContainer) {
                    tickerContainer.innerHTML = "";
                    const s1 = document.createElement("script");
                    s1.src = "https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js";
                    s1.async = true;
                    s1.innerHTML = JSON.stringify({
                        "symbols": [
                            { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                            { "proName": "FOREXCOM:NSXUSD", "title": "Nasdaq 100" },
                            { "proName": "FX_IDC:EURUSD", "title": "EUR to USD" },
                            { "proName": "BITSTAMP:BTCUSD", "title": "Bitcoin" },
                            { "proName": "BITSTAMP:ETHUSD", "title": "Ethereum" },
                            { "proName": "NASDAQ:TSLA", "title": "Tesla" },
                            { "proName": "NASDAQ:NVDA", "title": "NVIDIA" },
                            { "proName": "NASDAQ:AAPL", "title": "Apple" },
                            { "proName": "NASDAQ:META", "title": "Meta" },
                            { "proName": "NASDAQ:AMZN", "title": "Amazon" },
                            { "proName": "NASDAQ:GOOGL", "title": "Google" },
                            { "proName": "NASDAQ:NFLX", "title": "Netflix" }
                        ],
                        "showSymbolLogo": true, "isTransparent": true, "displayMode": "adaptive", "colorTheme": "light", "locale": "zh_TW"
                    });
                    tickerContainer.appendChild(s1);
                }

                // 2. Kç·šåœ– (é€£å‹•é‚è¼¯)
                function updateChart(symbol) {
                    const chartContainer = document.getElementById("tv-advanced-chart");
                    if (chartContainer) {
                        chartContainer.innerHTML = "";
                        const s2 = document.createElement("script");
                        s2.src = "https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js";
                        s2.async = true;
                        s2.innerHTML = JSON.stringify({
                            "autosize": true, "symbol": symbol, "interval": "D", "timezone": "Asia/Taipei", "theme": "light", "style": "1", "locale": "zh_TW", "allow_symbol_change": true, "calendar": false, "support_host": "https://www.tradingview.com"
                        });
                        chartContainer.appendChild(s2);
                    }
                }

                // 3. â˜…â˜…â˜… æ–°å¢ï¼šè‚¡ç¥¨ç†±åŠ›åœ– (Heatmap) â˜…â˜…â˜…
                const heatmapContainer = document.getElementById("tv-stock-heatmap");
                if (heatmapContainer) {
                    heatmapContainer.innerHTML = "";
                    const s3 = document.createElement("script");
                    s3.src = "https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js";
                    s3.async = true;
                    s3.innerHTML = JSON.stringify({
                        "dataSource": "SPX500",
                        "blockSize": "market_cap_basic",
                        "blockColor": "change",
                        "grouping": "sector",
                        "locale": "zh_TW", 
                        "symbolUrl": "",
                        "colorTheme": "light",
                        "hasTopBar": false,
                        "isDataSetEnabled": false,
                        "isZoomEnabled": true,
                        "hasSymbolTooltip": true,
                        "isMonoSize": false,
                        "width": "100%",
                        "height": "100%",
                        "isTransparent": true 
                    });
                    heatmapContainer.appendChild(s3);
                }

                // 4. â˜…â˜…â˜… æ–°å¢ï¼šå¸‚å ´æ¦‚è¦½ (Market Quotes) â˜…â˜…â˜…
                const quotesContainer = document.getElementById("tv-market-quotes");
                if (quotesContainer) {
                    quotesContainer.innerHTML = "";
                    const s4 = document.createElement("script");
                    s4.src = "https://s3.tradingview.com/external-embedding/embed-widget-market-quotes.js";
                    s4.async = true;
                    s4.innerHTML = JSON.stringify({
                        "colorTheme": "light",
                        "locale": "zh_TW",
                        "largeChartUrl": "",
                        "isTransparent": true,
                        "showSymbolLogo": true,
                        "width": "100%",  
                        "height": "100%", 
                        "symbolsGroups": [
                            {
                                "name": "æŒ‡æ•¸",
                                "symbols": [
                                    { "name": "FOREXCOM:SPXUSD", "displayName": "S&P 500" },
                                    { "name": "FOREXCOM:NSXUSD", "displayName": "Nasdaq 100" },
                                    { "name": "FOREXCOM:DJI", "displayName": "é“ç“ŠæŒ‡æ•¸" },
                                    { "name": "INDEX:NKY", "displayName": "æ—¥ç¶“ 225" },
                                    { "name": "INDEX:DEU40", "displayName": "å¾·åœ‹ DAX" },
                                    { "name": "FOREXCOM:UKXGBP", "displayName": "è‹±åœ‹å¯Œæ™‚ 100" }
                                ]
                            },
                            {
                                "name": "æœŸè²¨",
                                "symbols": [
                                    { "name": "CMCMARKETS:GOLD", "displayName": "é»ƒé‡‘" },
                                    { "name": "PYTH:WTI3!", "displayName": "åŸæ²¹" },
                                    { "name": "BMFBOVESPA:CCM1!", "displayName": "ç‰ç±³" }
                                ]
                            },
                            {
                                "name": "å¤–åŒ¯",
                                "symbols": [
                                    { "name": "FX:EURUSD", "displayName": "æ­å…ƒ/ç¾å…ƒ" },
                                    { "name": "FX:USDJPY", "displayName": "ç¾å…ƒ/æ—¥åœ“" },
                                    { "name": "FX:GBPUSD", "displayName": "è‹±éŠ/ç¾å…ƒ" }
                                ]
                            }
                        ]
                    });
                    quotesContainer.appendChild(s4);
                }

                // 5. å…¨çƒæ–°è (Top Stories)
                const timelineContainer = document.getElementById("tv-timeline");
                if (timelineContainer) {
                    timelineContainer.innerHTML = "";
                    const s5 = document.createElement("script");
                    s5.src = "https://s3.tradingview.com/external-embedding/embed-widget-timeline.js";
                    s5.async = true;
                    s5.innerHTML = JSON.stringify({
                        "feedMode": "all_symbols",
                        "displayMode": "regular",
                        "colorTheme": "light",
                        "isTransparent": true,
                        "width": "100%",
                        "height": "100%",
                        "locale": "zh_TW"
                    });
                    timelineContainer.appendChild(s5);
                }

                // 6. ç¶å®šé¸å–®äº‹ä»¶
                const selector = document.getElementById("stock-selector");
                if (selector) {
                    selector.addEventListener("change", function(e) {
                        updateChart(e.target.value);
                    });
                    // åˆå§‹åŒ–
                    updateChart(selector.value);
                }
            })();
            </script>



            <!-- ç³»çµ±è¨­ç½® -->
            <div class="content-section" id="settings">
                <div class="section-header"><h2>ç³»çµ±è¨­ç½®</h2><p>å€‹æ€§åŒ–æ‚¨çš„ç†è²¡æ‡‰ç”¨é«”é©—</p></div>

                <div class="settings-option">
                    <div>
                        <h3>ä¸»é¡Œæ¨¡å¼</h3>
                        <p>åˆ‡æ›æ·ºè‰² / æš—è‰²</p>
                    </div>
                    <div>
                        <label style="margin-right:8px">æ·ºè‰²</label>
                        <input type="checkbox" id="theme-toggle">
                    </div>
                </div>

                <div class="settings-option">
                    <div>
                        <h3>è²¨å¹£å–®ä½</h3>
                        <p>è«‹é¸æ“‡é è¨­è²¨å¹£ï¼ˆé è¨­ï¼šæ–°å°å¹£ TWDï¼‰</p>
                    </div>
                    <div>
                        <select id="currency-select" style="padding:6px;border-radius:6px">
                            <option value="TWD" selected>æ–°å°å¹£ (TWD)</option>
                            <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                            <option value="USD">ç¾å…ƒ (USD)</option>
                            <option value="EUR">æ­å…ƒ (EUR)</option>
                            <option value="JPY">æ—¥å…ƒ (JPY)</option>
                        </select>
                    </div>
                </div>

                <!-- # ä¸éœ€è¦ï¼šæ•¸æ“šå‚™ä»½åŠŸèƒ½ï¼ˆå·²ç§»é™¤ï¼‰
                # <div class="settings-option" id="backup-option">
                #     <div><h3>æ•¸æ“šå‚™ä»½</h3><p>è‡ªå‹•å‚™ä»½æ•¸æ“šåˆ°é›²ç«¯</p></div>
                #     <label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label>
                # </div>
                -->
                <!-- å·²ä»¥ HTML è¨»è§£åˆ—å‡ºï¼Œä¸¦åœ¨ä¸Šæ–¹ä¿ç•™ # æ¨™ç¤ºèªªæ˜ -->
            </div>
        </div>
    </div>

    <!-- =========================
         JavaScriptï¼šè³‡æ–™èˆ‡ UI é‚è¼¯
         èªªæ˜ï¼š
         - ä¿æŒèˆ‡ register.html å…±ç”¨ localStorage çš„ 'users' çµæ§‹
         - register.html æœƒæŠŠä½¿ç”¨è€…å¯«å…¥ localStorage.users[username]ï¼Œé€™è£¡ç™»å…¥æœƒè®€å– users ä¸¦åœ¨ç™»å…¥æˆåŠŸå¾Œè®€å–è©²ä½¿ç”¨è€…çš„ transactions, categories, budgets, goals, recurring
         - ç™»å…¥å‰çœ‹ä¸åˆ°ä»»ä½•ä½¿ç”¨è€…è³‡æ–™ï¼ˆä¹Ÿå°±æ˜¯ä½ è¦æ±‚çš„ã€Œç™»å…¥å‰æ¸…é›¶ã€ç™»å…¥å¾Œæ‰çœ‹åˆ°å€‹äººè³‡æ–™ã€ï¼‰
         - æ‰€æœ‰åœ–è¡¨å®Œå…¨ç”± transactions é©…å‹•ï¼ˆè‹¥ç„¡äº¤æ˜“å‰‡é¡¯ç¤ºã€Œæš«ç„¡è³‡æ–™/0ã€ï¼‰
         ============================ -->
    <script>
        // ---------- å…¨åŸŸæœ¬åœ°å„²å­˜éµï¼ˆä¿æŒèˆ‡ register.html ä¸€è‡´ï¼‰ ----------
        // register.html ä½¿ç”¨ localStorage.getItem('users'), æ‰€ä»¥æˆ‘å€‘ç¹¼çºŒæ²¿ç”¨ 'users'ï¼Œ
        // ä½†ç‚ºäº†æ–¹ä¾¿ï¼Œæˆ‘æœƒåœ¨ users[username] åº•ä¸‹å»ºç«‹æ›´å¤šå±¬æ€§ï¼štransactions, categories, budgets, goals, recurring, lastRecurringApplied
        // ç¯„ä¾‹çµæ§‹ï¼š
        // localStorage.users = {
        //   "alice": { email: "...", password: "...", transactions: [...], categories: [...], budgets: {...}, goals:[...], recurring:[...], lastRecurringApplied: {...} },
        //   ...
        // }

        // å·¥å…·å‡½å¼ï¼šè®€/å¯« users ç‰©ä»¶
        function loadUsers() {
            try {
                return JSON.parse(localStorage.getItem('users') || '{}');
            } catch (e) {
                console.error('è§£æ users å¤±æ•—', e);
                return {};
            }
        }
        function saveUsers(users) {
            localStorage.setItem('users', JSON.stringify(users));
        }

        // DataManagerï¼šè™•ç†ä»¥ä½¿ç”¨è€…ç‚ºå–®ä½çš„è³‡æ–™
        const DataManager = {
            // è®€å–ç›®å‰ç™»å…¥ä½¿ç”¨è€…ï¼ˆåŒæ™‚æ”¯æ´ register.html è¨»å†Šç”¢ç”Ÿçš„ users çµæ§‹ï¼‰
            getCurrentUsername() {
                // åŸæœ¬ index.html ä½¿ç”¨ localStorage.getItem('currentUser')ï¼Œæˆ‘å€‘ä¿ç•™æ­¤éµä»¥æ”¯æ´æ—¢æœ‰æµç¨‹
                return localStorage.getItem('currentUser') || '';
            },

            setCurrentUsername(username) {
                localStorage.setItem('currentUser', username || '');
            },

            isLoggedIn() {
                const u = this.getCurrentUsername();
                if (!u) return false;
                const users = loadUsers();
                return !!users[u];
            },

            // å–å¾—ä½¿ç”¨è€…å®Œæ•´è³‡æ–™ï¼ˆè‹¥æ²’æœ‰å¿…è¦æ¬„ä½å‰‡è£œä¸Šé è¨­ï¼‰
            getUserData() {
                const username = this.getCurrentUsername();
                if (!username) return null;
                const users = loadUsers();
                const user = users[username];
                if (!user) return null;
                // è£œæ¬„ä½
                user.transactions = user.transactions || [];
                user.categories = user.categories || [
                    'salary','investment','gift','other-income',
                    'food','shopping','transportation','entertainment','housing','other-expense'
                ];
                user.budgets = user.budgets || {};
                user.goals = user.goals || [];
                user.recurring = user.recurring || [];
                user.lastRecurringApplied = user.lastRecurringApplied || {};
                return user;
            },

            // æ–°å¢äº¤æ˜“ï¼ˆæœƒå­˜åˆ°è©²ä½¿ç”¨è€…çš„ transactionsï¼‰
            addTransaction(tx) {
                const username = this.getCurrentUsername();
                if (!username) return { success: false, message: 'ä½¿ç”¨è€…æœªç™»å…¥' };
                const users = loadUsers();
                if (!users[username]) return { success: false, message: 'ä½¿ç”¨è€…ä¸å­˜åœ¨' };
                const user = users[username];
                user.transactions = user.transactions || [];
                // id ä½¿ç”¨æ™‚é–“æˆ³åŠ éš¨æ©Ÿæ•¸
                tx.id = Date.now() + Math.floor(Math.random() * 1000);
                tx.amount = Number(tx.amount);
                // å¦‚æœå‚³å…¥ date ç‚º yyyy-mm-ddï¼Œä¿ç•™ ISO å­—ä¸²
                user.transactions.push(tx);
                saveUsers(users);
                return { success: true };
            },

            deleteTransaction(id) {
                const username = this.getCurrentUsername();
                if (!username) return { success: false, message: 'ä½¿ç”¨è€…æœªç™»å…¥' };
                const users = loadUsers();
                const user = users[username];
                if (!user) return { success: false, message: 'ä½¿ç”¨è€…ä¸å­˜åœ¨' };
                user.transactions = (user.transactions || []).filter(t => t.id !== id);
                saveUsers(users);
                return { success: true };
            },

            addCategory(name) {
                const username = this.getCurrentUsername();
                if (!username) return { success: false, message: 'ä½¿ç”¨è€…æœªç™»å…¥' };
                const users = loadUsers();
                const user = users[username];
                user.categories = user.categories || [];
                if (user.categories.includes(name)) return { success: false, message: 'åˆ†é¡å·²å­˜åœ¨' };
                user.categories.push(name);
                saveUsers(users);
                return { success: true };
            },

            deleteCategory(name) {
                const username = this.getCurrentUsername();
                if (!username) return { success: false, message: 'ä½¿ç”¨è€…æœªç™»å…¥' };
                const users = loadUsers();
                const user = users[username];
                user.categories = (user.categories || []).filter(c => c !== name);
                // æŠŠè©²åˆ†é¡çš„äº¤æ˜“æ”¹ç‚º other-expense / other-income
                user.transactions = (user.transactions || []).map(t => {
                    if (t.category === name) t.category = t.type === 'income' ? 'other-income' : 'other-expense';
                    return t;
                });
                saveUsers(users);
                return { success: true };
            },

            setBudget(category, amount) {
                const username = this.getCurrentUsername();
                if (!username) return { success: false, message: 'ä½¿ç”¨è€…æœªç™»å…¥' };
                const users = loadUsers();
                const user = users[username];
                user.budgets = user.budgets || {};
                user.budgets[category] = Number(amount);
                saveUsers(users);
                return { success: true };
            },

            getBudgets() {
                const user = this.getUserData();
                return user ? (user.budgets || {}) : {};
            },

            addGoal(goal) {
                const username = this.getCurrentUsername();
                if (!username) return { success: false, message: 'ä½¿ç”¨è€…æœªç™»å…¥' };
                const users = loadUsers();
                const user = users[username];
                goal.id = Date.now() + Math.floor(Math.random() * 1000);
                goal.createdAt = new Date().toISOString();
                user.goals = user.goals || [];
                user.goals.push(goal);
                saveUsers(users);
                return { success: true };
            },

            deleteGoal(id) {
                const username = this.getCurrentUsername();
                if (!username) return { success: false, message: 'ä½¿ç”¨è€…æœªç™»å…¥' };
                const users = loadUsers();
                const user = users[username];
                user.goals = (user.goals || []).filter(g => g.id !== id);
                saveUsers(users);
                return { success: true };
            },

            addRecurring(r) {
                const username = this.getCurrentUsername();
                if (!username) return { success: false, message: 'ä½¿ç”¨è€…æœªç™»å…¥' };
                const users = loadUsers();
                const user = users[username];
                r.id = Date.now() + Math.floor(Math.random() * 1000);
                user.recurring = user.recurring || [];
                user.recurring.push(r);
                saveUsers(users);
                return { success: true };
            },

            deleteRecurring(id) {
                const username = this.getCurrentUsername();
                if (!username) return { success: false, message: 'ä½¿ç”¨è€…æœªç™»å…¥' };
                const users = loadUsers();
                const user = users[username];
                user.recurring = (user.recurring || []).filter(rr => rr.id !== id);
                saveUsers(users);
                return { success: true };
            },

            applyRecurringIfNeeded() {
                // æ¯æ¬¡ç™»å…¥æ™‚æª¢æŸ¥ï¼Œè‹¥æœ¬æœˆå°šæœªæŠŠ recurring åŠ å…¥ transactions å°±åŠ å…¥ä¸€æ¬¡
                const username = this.getCurrentUsername();
                if (!username) return;
                const users = loadUsers();
                const user = users[username];
                user.lastRecurringApplied = user.lastRecurringApplied || {};
                const now = new Date();
                const monthKey = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2, '0');
                if (user.lastRecurringApplied[monthKey]) {
                    // æœ¬æœˆå·²æ‡‰ç”¨é
                    saveUsers(users);
                    return;
                }
                // æ‡‰ç”¨æ¯ä¸€å€‹ recurringï¼ˆä»¥ day ç‚ºåŸºæº–ï¼Œè‹¥è¶…éæœˆä»½å¤©æ•¸å‰‡ä½¿ç”¨ç•¶æœˆæœ€å¾Œä¸€æ—¥ï¼‰
                (user.recurring || []).forEach(r => {
                    const day = Math.max(1, Math.min(28, Number(r.day) || 1)); // é™ 1-28
                    const d = new Date(now.getFullYear(), now.getMonth(), day);
                    const tx = { type: r.type, amount: Number(r.amount), category: r.category, description: r.description || 'é€±æœŸäº¤æ˜“', date: d.toISOString(), id: Date.now()+Math.floor(Math.random()*1000) };
                    user.transactions = user.transactions || [];
                    user.transactions.push(tx);
                });
                user.lastRecurringApplied[monthKey] = true;
                saveUsers(users);
            }
        };

        // ---------- UI ç®¡ç†ï¼ˆæ§åˆ¶ DOM èˆ‡åœ–è¡¨ï¼‰ ----------
        const UI = {
            init() {
                this.cacheElements();
                this.bindEvents();
                // è¨­å®šæ—¥æœŸæ¬„ç‚ºä»Šå¤©
                const dateInput = document.getElementById('date');
                if (dateInput) dateInput.valueAsDate = new Date();
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                this.checkLoginStatus();
            },

            cacheElements() {
                this.el = {
                    // auth
                    authForms: document.getElementById('auth-forms'),
                    loginForm: document.getElementById('login-form'),
                    loginBtn: document.getElementById('login-btn'),
                    showRegister: document.getElementById('show-register'),
                    logoutBtn: document.getElementById('logout-btn'),
                    userInfo: document.getElementById('user-info'),
                    userGreeting: document.getElementById('user-greeting'),
                    userEmail: document.getElementById('user-email'),
                    navMenu: document.getElementById('nav-menu'),
                    navLinks: document.querySelectorAll('.nav-link'),
                    contentSections: document.querySelectorAll('.content-section'),
                    welcome: document.getElementById('welcome-message'),

                    // transactions
                    addTransactionBtn: document.getElementById('add-transaction'),
                    amount: document.getElementById('amount'),
                    type: document.getElementById('type'),
                    categorySelect: document.getElementById('category'),
                    description: document.getElementById('description'),
                    date: document.getElementById('date'),
                    overviewTransactions: document.getElementById('overview-transactions'),
                    allTransactions: document.getElementById('all-transactions'),

                    // export
                    exportCsvBtn: document.getElementById('export-csv'),

                    // budgets
                    budgetCategory: document.getElementById('budget-category'),
                    budgetAmount: document.getElementById('budget-amount'),
                    setBudgetBtn: document.getElementById('set-budget'),
                    budgetsList: document.getElementById('budgets-list'),

                    // goals
                    goalName: document.getElementById('goal-name'),
                    goalAmount: document.getElementById('goal-amount'),
                    goalDeadline: document.getElementById('goal-deadline'),
                    addGoalBtn: document.getElementById('add-goal'),
                    goalsList: document.getElementById('goals-list'),

                    // recurring
                    recType: document.getElementById('rec-type'),
                    recAmount: document.getElementById('rec-amount'),
                    recCategory: document.getElementById('rec-category'),
                    recDay: document.getElementById('rec-day'),
                    addRecurringBtn: document.getElementById('add-recurring'),
                    recurringList: document.getElementById('recurring-list'),

                    // categories
                    newCategoryInput: document.getElementById('new-category'),
                    addCategoryBtn: document.getElementById('add-category'),
                    categoriesList: document.getElementById('categories-list'),

                    // charts
                    flowCanvas: document.getElementById('flow-chart'),
                    analyticsCanvas: document.getElementById('analytics-chart'),
                    categoryCanvas: document.getElementById('category-chart'),

                    // settings
                    themeToggle: document.getElementById('theme-toggle'),
                    currencySelect: document.getElementById('currency-select'),
                };

                this.charts = { flow: null, analytics: null, category: null };
            },

            bindEvents() {
                // ä¿ç•™ç™»å…¥æŒ‰éˆ•è¡Œç‚ºï¼šåŸå…ˆ index.html æœ‰ä¸€æ®µç™»å…¥ç¨‹å¼ï¼Œè‹¥ä½ åŸæœ¬æœ‰é€™æ®µè«‹ä¿ç•™ id(login-btn)
                // é€™é‚Šæˆ‘å€‘å‡è¨­ç™»å…¥æŒ‰éˆ•å­˜åœ¨ï¼Œä¸¦åœ¨ç™»å…¥æˆåŠŸæ™‚è¨­å®š localStorage.currentUser
                const loginBtn = document.getElementById('login-btn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', () => {
                        const username = document.getElementById('username').value.trim();
                        const password = document.getElementById('password').value;
                        const users = loadUsers();
                        if (!username || !password) { alert('è«‹è¼¸å…¥ç”¨æˆ¶åå’Œå¯†ç¢¼'); return; }
                        if (!users[username]) { alert('ä½¿ç”¨è€…ä¸å­˜åœ¨ï¼Œè«‹å…ˆè¨»å†Š'); return; }
                        if (users[username].password !== password) { alert('å¯†ç¢¼éŒ¯èª¤'); return; }
                        // ç™»å…¥æˆåŠŸï¼šè¨­å®š currentUserï¼Œéš±è—ç™»å…¥ç•«é¢ä¸¦é¡¯ç¤ºä¸»ç³»çµ±
                        localStorage.setItem('currentUser', username);
                        // è‹¥ä½¿ç”¨è€…è³‡æ–™ç¼ºå°‘æ¬„ä½ï¼Œè£œä¸Šé è¨­
                        users[username].transactions = users[username].transactions || [];
                        users[username].categories = users[username].categories || [
                            'salary','investment','gift','other-income',
                            'food','shopping','transportation','entertainment','housing','other-expense'
                        ];
                        users[username].budgets = users[username].budgets || {};
                        users[username].goals = users[username].goals || [];
                        users[username].recurring = users[username].recurring || [];
                        users[username].lastRecurringApplied = users[username].lastRecurringApplied || {};
                        saveUsers(users);

                        // æ‡‰ç”¨é€±æœŸäº¤æ˜“ï¼ˆå¦‚æœæœ¬æœˆæœªæ‡‰ç”¨ï¼‰
                        DataManager.applyRecurringIfNeeded();

                        this.showLoggedInState(username);
                    });
                }

                // è¨»å†Šé€£çµï¼ˆè‹¥å­˜åœ¨ï¼‰
                const showRegister = document.getElementById('show-register');
                if (showRegister) {
                    showRegister.addEventListener('click', () => {
                        // ä»¥åŸå…ˆè¡Œç‚ºæ‰“é–‹ register.htmlï¼ˆä¿æŒä¸è®Šï¼‰
                        window.open('register.html', '_blank');
                    });
                }

                // ç™»å‡º
                const logoutBtn = this.el.logoutBtn;
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        localStorage.setItem('currentUser', '');
                        // å›åˆ°æœªç™»å…¥ç‹€æ…‹ï¼ˆæ‰€æœ‰è³‡æ–™å€å¡Šéš±è—ï¼‰
                        this.showLoggedOutState();
                    });
                }

                // å´é‚Šå°èˆªåˆ‡æ›
                this.el.navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = e.currentTarget.getAttribute('data-target');
                        this.showContentSection(target);
                    });
                });

                // æ–°å¢äº¤æ˜“
                if (this.el.addTransactionBtn) {
                    this.el.addTransactionBtn.addEventListener('click', () => {
                        const type = this.el.type.value;
                        const amount = Number(this.el.amount.value);
                        const category = this.el.categorySelect.value;
                        const description = this.el.description.value;
                        const date = this.el.date.value;
                        if (!amount || !date) { alert('è«‹å¡«å¯«é‡‘é¡èˆ‡æ—¥æœŸ'); return; }
                        const tx = { type, amount, category, description, date: new Date(date).toISOString() };
                        const r = DataManager.addTransaction(tx);
                        if (!r.success) { alert(r.message); return; }
                        this.el.amount.value = '';
                        this.el.description.value = '';
                        if (this.el.date) this.el.date.valueAsDate = new Date();
                        this.updateUI();
                        this.checkBudgetAlert(category);
                    });
                }

                // åŒ¯å‡º CSV
                if (this.el.exportCsvBtn) {
                    this.el.exportCsvBtn.addEventListener('click', () => {
                        const username = DataManager.getCurrentUsername();
                        if (!username) { alert('è«‹å…ˆç™»å…¥'); return; }
                        const users = loadUsers();
                        const txs = (users[username] && users[username].transactions) ? users[username].transactions : [];
                        if (!txs.length) { alert('ç„¡äº¤æ˜“å¯åŒ¯å‡º'); return; }
                        const header = ['id','type','amount','category','description','date'];
                        const rows = txs.map(t => [t.id, t.type, t.amount, t.category, `"${(t.description||'').replace(/"/g,'""')}"`, t.date].join(','));
                        const csv = [header.join(','), ...rows].join('\n');
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'transactions.csv';
                        a.click();
                        URL.revokeObjectURL(url);
                    });
                }

                // åˆ†é¡æ–°å¢
                if (this.el.addCategoryBtn) {
                    this.el.addCategoryBtn.addEventListener('click', () => {
                        const name = this.el.newCategoryInput.value.trim();
                        if (!name) { alert('è«‹è¼¸å…¥åˆ†é¡åç¨±'); return; }
                        const r = DataManager.addCategory(name);
                        if (!r.success) { alert(r.message); return; }
                        this.el.newCategoryInput.value = '';
                        this.refreshCategoryUI();
                    });
                }

                // è¨­å®šé ç®—
                if (this.el.setBudgetBtn) {
                    this.el.setBudgetBtn.addEventListener('click', () => {
                        const cat = this.el.budgetCategory.value;
                        const amt = Number(this.el.budgetAmount.value);
                        if (!cat || !amt) { alert('è«‹é¸æ“‡é¡åˆ¥èˆ‡è¨­å®šé‡‘é¡'); return; }
                        DataManager.setBudget(cat, amt);
                        this.el.budgetAmount.value = '';
                        this.refreshBudgets();
                        alert('å·²è¨­å®šé ç®—');
                    });
                }

                // ç›®æ¨™æ–°å¢
                if (this.el.addGoalBtn) {
                    this.el.addGoalBtn.addEventListener('click', () => {
                        const name = this.el.goalName.value.trim();
                        const amount = Number(this.el.goalAmount.value);
                        const deadline = this.el.goalDeadline.value;
                        if (!name || !amount || !deadline) { alert('è«‹å®Œæ•´å¡«å¯«ç›®æ¨™è³‡è¨Š'); return; }
                        DataManager.addGoal({ name, amount, deadline });
                        this.el.goalName.value = ''; this.el.goalAmount.value = ''; this.el.goalDeadline.value = '';
                        this.refreshGoals();
                    });
                }

                // æ–°å¢é€±æœŸ
                if (this.el.addRecurringBtn) {
                    this.el.addRecurringBtn.addEventListener('click', () => {
                        const type = this.el.recType.value;
                        const amount = Number(this.el.recAmount.value);
                        const category = this.el.recCategory.value;
                        const day = Number(this.el.recDay.value);
                        if (!amount || !category || !day) { alert('è«‹å®Œæ•´å¡«å¯«é€±æœŸäº¤æ˜“'); return; }
                        DataManager.addRecurring({ type, amount, category, day });
                        this.el.recAmount.value = ''; this.el.recDay.value = '';
                        this.refreshRecurring();
                    });
                }

                // ä¸»é¡Œåˆ‡æ›
                if (this.el.themeToggle) {
                    // è®€å–ä¹‹å‰è¨­å®š
                    const t = localStorage.getItem('pfm_theme_light') === '1';
                    this.el.themeToggle.checked = t;
                    if (t) document.documentElement.setAttribute('data-theme', 'light');
                    else document.documentElement.removeAttribute('data-theme');

                    this.el.themeToggle.addEventListener('change', () => {
                        const light = this.el.themeToggle.checked;
                        if (light) document.documentElement.setAttribute('data-theme', 'light');
                        else document.documentElement.removeAttribute('data-theme');
                        localStorage.setItem('pfm_theme_light', light ? '1' : '0');
                    });
                }

                // è²¨å¹£é¸æ“‡
                if (this.el.currencySelect) {
                    const cur = localStorage.getItem('pfm_currency') || 'TWD';
                    this.el.currencySelect.value = cur;
                    this.el.currencySelect.addEventListener('change', () => {
                        const val = this.el.currencySelect.value;
                        localStorage.setItem('pfm_currency', val);
                        this.updateUI();
                    });
                }
            },

            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            checkLoginStatus() {
                if (DataManager.isLoggedIn()) {
                    const username = DataManager.getCurrentUsername();
                    // æ‡‰ç”¨é€±æœŸäº¤æ˜“ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    DataManager.applyRecurringIfNeeded();
                    this.showLoggedInState(username);
                } else {
                    this.showLoggedOutState();
                }
            },

            showLoggedInState(username) {
                // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Šã€å°è¦½
                this.el.userInfo.classList.add('active');
                this.el.navMenu.classList.add('active');
                this.el.authForms.style.display = 'none';
                document.getElementById('welcome-message') && document.getElementById('welcome-message').classList.remove('active');
                this.el.userGreeting.textContent = `æ­¡è¿ï¼Œ${username}ï¼`;
                const users = loadUsers();
                this.el.userEmail.textContent = (users[username] && users[username].email) ? users[username].email : '';

                // åˆå§‹åŒ–å­é é¢è³‡æ–™
                this.refreshCategoryUI();
                this.refreshBudgets();
                this.refreshGoals();
                this.refreshRecurring();

                // é¡¯ç¤ºæ¦‚è¦½
                this.showContentSection('overview');
                // æ›´æ–° UIï¼ˆåŒ…æ‹¬åœ–è¡¨ï¼‰
                this.updateUI();
            },

            showLoggedOutState() {
                // é¡¯ç¤ºç™»å…¥è¡¨å–®ã€éš±è—æ‰€æœ‰å…§å®¹
                this.el.userInfo.classList.remove('active');
                this.el.navMenu.classList.remove('active');
                this.el.authForms.style.display = 'block';
                // éš±è—æ‰€æœ‰å…§å®¹å€
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                // é¡¯ç¤ºæ­¡è¿
                document.getElementById('welcome-message') && document.getElementById('welcome-message').classList.add('active');
            },

            showContentSection(id) {
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                if (!id) return;
                const sec = document.getElementById(id);
                if (sec) sec.classList.add('active');
                const link = document.querySelector(`[data-target="${id}"]`);
                if (link) link.classList.add('active');

                // ç•¶åˆ‡æ›åˆ°åœ–è¡¨é é¢æ™‚æ›´æ–°åœ–è¡¨
                if (id === 'analytics' || id === 'overview') this.updateUI();
                if (id === 'budgets') this.refreshBudgets();
                if (id === 'goals') this.refreshGoals();
                if (id === 'recurring') this.refreshRecurring();
                if (id === 'categories') this.refreshCategoryUI();
            },

            // æ›´æ–°æ•´å€‹ UI
            updateUI() {
                const username = DataManager.getCurrentUsername();
                if (!username) return;
                const users = loadUsers();
                const user = users[username];
                if (!user) return;

                const txs = user.transactions || [];
                const totalIncome = txs.filter(t => t.type === 'income').reduce((s, t) => s + Number(t.amount), 0);
                const totalExpense = txs.filter(t => t.type === 'expense').reduce((s, t) => s + Number(t.amount), 0);
                const balance = totalIncome - totalExpense;

                const currency = localStorage.getItem('pfm_currency') || 'TWD';
                const symbol = this.getCurrencySymbol(currency);

                document.getElementById('total-income').textContent = `${symbol}${this.numFmt(totalIncome)}`;
                document.getElementById('total-expense').textContent = `${symbol}${this.numFmt(totalExpense)}`;
                document.getElementById('balance').textContent = `${symbol}${this.numFmt(balance)}`;

                document.getElementById('overview-transactions').innerHTML = '';
                document.getElementById('all-transactions').innerHTML = '';

                // æœ€è¿‘ 5 ç­†äº¤æ˜“ï¼ˆè‹¥ç‚ºç©ºå‰‡é¡¯ç¤ºç„¡è³‡æ–™ï¼‰
                if (!txs.length) {
                    document.getElementById('overview-transactions').innerHTML = '<p style="text-align:center;color:var(--muted);padding:12px">æš«ç„¡äº¤æ˜“è¨˜éŒ„</p>';
                    document.getElementById('all-transactions').innerHTML = '<p style="text-align:center;color:var(--muted);padding:12px">æš«ç„¡äº¤æ˜“è¨˜éŒ„</p>';
                } else {
                    const sorted = txs.slice().sort((a,b) => new Date(b.date) - new Date(a.date));
                    const recent = sorted.slice(0,5);
                    recent.forEach(t => document.getElementById('overview-transactions').appendChild(this.createTransactionElement(t)));
                    sorted.forEach(t => document.getElementById('all-transactions').appendChild(this.createTransactionElement(t)));
                }

                // æœ¬æœˆæ•¸æ“š
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthTx = txs.filter(t => new Date(t.date) >= monthStart);
                const monthIncome = monthTx.filter(t => t.type === 'income').reduce((s,t) => s + Number(t.amount), 0);
                const monthExpense = monthTx.filter(t => t.type === 'expense').reduce((s,t) => s + Number(t.amount), 0);
                document.getElementById('month-income').textContent = `${symbol}${this.numFmt(monthIncome)}`;
                document.getElementById('month-expense').textContent = `${symbol}${this.numFmt(monthExpense)}`;

                // æœ€å¤§æ”¯å‡ºé¡åˆ¥
                const expenseByCat = {};
                txs.filter(t => t.type === 'expense').forEach(t => {
                    expenseByCat[t.category] = (expenseByCat[t.category] || 0) + Number(t.amount);
                });
                const topCat = Object.entries(expenseByCat).sort((a,b) => b[1] - a[1])[0];
                document.getElementById('top-category').textContent = topCat ? `${this.getCategoryName(topCat[0])} (${symbol}${this.numFmt(topCat[1])})` : '-';

                // æ›´æ–°åœ–è¡¨ï¼ˆæ‰€æœ‰åœ–è¡¨çš†ç”± txs é©…å‹•ï¼‰
                this.updateCharts(txs);
            },

            createTransactionElement(t) {
                const el = document.createElement('div');
                el.className = 'transaction-item';
                const d = new Date(t.date);
                const dateStr = d.toLocaleDateString();
                const catName = this.getCategoryName(t.category);
                const symbol = this.getCurrencySymbol(localStorage.getItem('pfm_currency') || 'TWD');
                el.innerHTML = `
                    <div style="display:flex;flex-direction:column">
                        <div style="font-weight:600;color:var(--text)">${t.description || catName}</div>
                        <div style="font-size:0.85rem;color:var(--muted)">${catName} â€¢ ${dateStr}</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                        <div class="transaction-amount ${t.type}">${t.type==='income'?'+':'-'}${symbol}${this.numFmt(Number(t.amount))}</div>
                        <button class="delete-btn" data-id="${t.id}">Ã—</button>
                    </div>
                `;
                const btn = el.querySelector('.delete-btn');
                btn.addEventListener('click', () => {
                    if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†äº¤æ˜“ï¼Ÿ')) return;
                    DataManager.deleteTransaction(Number(btn.getAttribute('data-id')));
                    this.updateUI();
                });
                return el;
            },

            // åˆ†é¡ UI æ›´æ–°
            refreshCategoryUI() {
                const username = DataManager.getCurrentUsername();
                if (!username) return;
                const users = loadUsers();
                const user = users[username];
                const cats = user.categories || [
                    'salary','investment','gift','other-income',
                    'food','shopping','transportation','entertainment','housing','other-expense'
                ];
                // æ›´æ–°ä¸‹æ‹‰é¸å–®
                this.el.categorySelect.innerHTML = '';
                this.el.recCategory.innerHTML = '';
                this.el.budgetCategory.innerHTML = '';
                cats.forEach(c => {
                    const opt = document.createElement('option'); opt.value = c; opt.textContent = this.getCategoryName(c);
                    this.el.categorySelect.appendChild(opt);
                    const opt2 = opt.cloneNode(true); this.el.recCategory.appendChild(opt2);
                    const opt3 = opt.cloneNode(true); this.el.budgetCategory.appendChild(opt3);
                });
                // é¡¯ç¤ºåˆ†é¡æ¸…å–®ï¼ˆå«åˆªé™¤æŒ‰éˆ•ï¼‰
                this.el.categoriesList.innerHTML = '';
                cats.forEach(c => {
                    const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginTop='6px';
                    div.innerHTML = `<div style="color:var(--muted)">${this.getCategoryName(c)}</div><div><button class="small" data-cat="${c}">åˆªé™¤</button></div>`;
                    const btn = div.querySelector('button');
                    btn.addEventListener('click', () => {
                        if (!confirm('åˆªé™¤åˆ†é¡æœƒå°‡è©²åˆ†é¡çš„äº¤æ˜“è½‰ç‚ºå…¶ä»–åˆ†é¡ï¼Œç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) return;
                        DataManager.deleteCategory(c);
                        this.refreshCategoryUI();
                        this.updateUI();
                    });
                    this.el.categoriesList.appendChild(div);
                });
            },

            // é ç®—é¡¯ç¤º
            refreshBudgets() {
                const budgets = DataManager.getBudgets();
                this.el.budgetsList.innerHTML = '';
                const keys = Object.keys(budgets);
                if (!keys.length) {
                    this.el.budgetsList.innerHTML = '<p style="color:var(--muted)">å°šç„¡é ç®—è¨­å®š</p>';
                    return;
                }
                keys.forEach(cat => {
                    const amt = budgets[cat];
                    const used = this.getMonthExpenseByCategory(cat);
                    const pct = amt > 0 ? Math.min(100, Math.round((used / amt) * 100)) : 0;
                    const div = document.createElement('div'); div.className = 'stat-card';
                    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>${this.getCategoryName(cat)}</strong><div style="color:var(--muted);font-size:0.9rem">å·²ç”¨ ${this.getCurrencySymbol(localStorage.getItem('pfm_currency')||'TWD')}${this.numFmt(used)} / ${this.getCurrencySymbol(localStorage.getItem('pfm_currency')||'TWD')}${this.numFmt(amt)}</div></div>
                        <div style="text-align:right">${pct}%</div>
                    </div>
                    <div class="progress" style="margin-top:8px"><div class="progress-bar" style="width:${pct}%;background:${pct>=100? 'var(--danger)':'var(--highlight)'}"></div></div>`;
                    this.el.budgetsList.appendChild(div);
                });
            },

            // ç›®æ¨™é¡¯ç¤º
            refreshGoals() {
                const username = DataManager.getCurrentUsername();
                if (!username) return;
                const users = loadUsers();
                const goals = (users[username] && users[username].goals) ? users[username].goals : [];
                this.el.goalsList.innerHTML = '';
                if (!goals.length) { this.el.goalsList.innerHTML = '<p style="color:var(--muted)">å°šç„¡ç›®æ¨™</p>'; return; }
                goals.forEach(g => {
                    const saved = this.getTotalSavedForGoal(g);
                    const progress = Math.min(100, Math.round((saved / g.amount) * 100));
                    const monthsLeft = Math.max(1, Math.ceil((new Date(g.deadline) - new Date()) / (1000*60*60*24*30)));
                    const monthlyNeed = Math.max(0, ((g.amount - saved) / monthsLeft));
                    const div = document.createElement('div'); div.className = 'goal-item';
                    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div style="font-weight:700">${g.name}</div>
                            <div style="color:var(--muted);font-size:0.9rem">ç›®æ¨™ï¼š${this.getCurrencySymbol(localStorage.getItem('pfm_currency')||'TWD')}${this.numFmt(g.amount)} â€¢ æˆªæ­¢ï¼š${new Date(g.deadline).toLocaleDateString()}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-weight:700">${progress}%</div>
                            <div style="color:var(--muted);font-size:0.85rem">æ¯æœˆéœ€ ${this.getCurrencySymbol(localStorage.getItem('pfm_currency')||'TWD')}${this.numFmt(monthlyNeed)}</div>
                        </div>
                    </div>
                    <div class="progress" style="margin-top:8px"><div class="progress-bar" style="width:${progress}%;"></div></div>
                    <div style="text-align:right;margin-top:8px"><button class="small" data-id="${g.id}">åˆªé™¤ç›®æ¨™</button></div>
                    `;
                    const btn = div.querySelector('button');
                    btn.addEventListener('click', () => {
                        if (!confirm('åˆªé™¤æ­¤å„²è“„ç›®æ¨™ï¼Ÿ')) return;
                        DataManager.deleteGoal(g.id);
                        this.refreshGoals();
                    });
                    this.el.goalsList.appendChild(div);
                });
            },

            // é€±æœŸé¡¯ç¤º
            refreshRecurring() {
                const username = DataManager.getCurrentUsername();
                if (!username) return;
                const users = loadUsers();
                const recs = (users[username] && users[username].recurring) ? users[username].recurring : [];
                this.el.recurringList.innerHTML = '';
                if (!recs.length) { this.el.recurringList.innerHTML = '<p style="color:var(--muted)">å°šç„¡é€±æœŸé …ç›®</p>'; return; }
                recs.forEach(r => {
                    const div = document.createElement('div'); div.className = 'stat-card';
                    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>${r.type==='income'?'æ”¶å…¥':'æ”¯å‡º'}</strong> â€¢ ${this.getCategoryName(r.category)} â€¢ æ¯æœˆç¬¬ ${r.day} æ—¥</div>
                        <div>${this.getCurrencySymbol(localStorage.getItem('pfm_currency')||'TWD')}${this.numFmt(r.amount)} <button class="small" data-id="${r.id}">åˆªé™¤</button></div>
                    </div>`;
                    const btn = div.querySelector('button');
                    btn.addEventListener('click', () => {
                        if (!confirm('åˆªé™¤æ­¤é€±æœŸäº¤æ˜“ï¼Ÿ')) return;
                        DataManager.deleteRecurring(Number(btn.getAttribute('data-id')));
                        this.refreshRecurring();
                    });
                    this.el.recurringList.appendChild(div);
                });
            },

            // æ›´æ–°åœ–è¡¨ï¼ˆå®Œå…¨ä»¥ txs åšç‚ºè³‡æ–™ä¾†æºï¼‰
            updateCharts(txs) {
                // txs ç‚ºè©²ä½¿ç”¨è€…çš„ transactions
                txs = txs || [];

                // Flow chart (æ”¶æ”¯æµé‡) - ä»¥æœˆç‚ºå–®ä½
                // å¦‚æœæ²’æœ‰ä»»ä½•äº¤æ˜“ï¼Œé¡¯ç¤ºç©ºæˆ– 0ï¼ˆä¸ä½¿ç”¨è™›æ§‹æ•¸æ“šï¼‰
                const months = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
                const monthIncome = new Array(12).fill(0);
                const monthExpense = new Array(12).fill(0);
                txs.forEach(t => {
                    const d = new Date(t.date);
                    if (isNaN(d)) return;
                    const m = d.getMonth();
                    if (t.type === 'income') monthIncome[m] += Number(t.amount);
                    else monthExpense[m] += Number(t.amount);
                });

                // destroy old
                if (this.charts.flow) this.charts.flow.destroy();
                // If all zeros, show chart with zeros but with a label "æš«ç„¡è³‡æ–™" in center (we'll show tooltip indicating no data)
                const hasData = monthIncome.some(v => v !== 0) || monthExpense.some(v => v !== 0);

                this.charts.flow = new Chart(this.el.flowCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            { label: 'æ”¶å…¥', data: monthIncome, borderColor: '#2ecc71', backgroundColor: 'rgba(46,204,113,0.1)', fill: true, tension:0.3 },
                            { label: 'æ”¯å‡º', data: monthExpense, borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: true, tension:0.3 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') || '#fff' } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const val = context.parsed.y || 0;
                                        return `${context.dataset.label}: ${val.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') } },
                            x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') } }
                        }
                    }
                });

                // Analytics bar chart: æ”¯å‡ºåˆ†é¡
                const expenseByCat = {};
                txs.filter(t => t.type === 'expense').forEach(t => {
                    expenseByCat[t.category] = (expenseByCat[t.category] || 0) + Number(t.amount);
                });
                const cats = Object.keys(expenseByCat);
                const vals = cats.map(c => expenseByCat[c]);

                if (this.charts.analytics) this.charts.analytics.destroy();
                this.charts.analytics = new Chart(this.el.analyticsCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: cats.map(c => this.getCategoryName(c)),
                        datasets: [{ label: 'æ”¯å‡ºé‡‘é¡', data: vals, borderWidth: 1 }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') } }, x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') } } }
                    }
                });

                // Category doughnut (é¡¯ç¤ºç™¾åˆ†æ¯”)
                const catLabels = cats.length ? cats : ['ç„¡æ”¯å‡º'];
                const catData = cats.length ? vals : [1];
                if (this.charts.category) this.charts.category.destroy();
                this.charts.category = new Chart(this.el.categoryCanvas.getContext('2d'), {
                    type: 'doughnut',
                    data: { labels: catLabels.map(c => this.getCategoryName(c)), datasets: [{ data: catData }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') } },
                            datalabels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                                formatter: (value, ctx) => {
                                    const sum = ctx.chart.data.datasets[0].data.reduce((a,b) => a + b, 0);
                                    const pct = sum ? (value / sum * 100).toFixed(0) : 0;
                                    return pct + '%';
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            },

            // å…¶ä»–è¼”åŠ©å‡½å¼
            getCategoryName(key) {
                const map = {
                    'salary':'å·¥è³‡','investment':'æŠ•è³‡','gift':'ç¦®ç‰©','other-income':'å…¶ä»–æ”¶å…¥',
                    'food':'é¤é£²','shopping':'è³¼ç‰©','transportation':'äº¤é€š','entertainment':'å¨›æ¨‚','housing':'ä½æˆ¿','other-expense':'å…¶ä»–æ”¯å‡º'
                };
                return map[key] || key;
            },

            numFmt(n) { return Number(n).toLocaleString(undefined, { maximumFractionDigits: 2, minimumFractionDigits: 2 }); },

            getCurrencySymbol(code) {
                switch(code) {
                    case 'TWD': return 'NT$';
                    case 'CNY': return 'Â¥';
                    case 'USD': return '$';
                    case 'EUR': return 'â‚¬';
                    case 'JPY': return 'Â¥';
                    default: return 'NT$';
                }
            },

            getMonthExpenseByCategory(cat) {
                const username = DataManager.getCurrentUsername();
                if (!username) return 0;
                const users = loadUsers();
                const txs = (users[username] && users[username].transactions) ? users[username].transactions : [];
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                return txs.filter(t => t.type === 'expense' && t.category === cat && new Date(t.date) >= monthStart).reduce((s,t) => s + Number(t.amount), 0);
            },

            checkBudgetAlert(category) {
                const budgets = DataManager.getBudgets();
                const budget = budgets[category];
                if (!budget) return;
                const used = this.getMonthExpenseByCategory(category);
                if (used >= budget) {
                    alert(`æ‚¨çš„ã€Œ${this.getCategoryName(category)}ã€å·²è¶…å‡ºé ç®—ï¼ˆ${this.getCurrencySymbol(localStorage.getItem('pfm_currency')||'TWD')}${this.numFmt(used)} / ${this.getCurrencySymbol(localStorage.getItem('pfm_currency')||'TWD')}${this.numFmt(budget)}ï¼‰`);
                } else if (used >= budget * 0.9) {
                    alert(`æ‚¨çš„ã€Œ${this.getCategoryName(category)}ã€æ¥è¿‘é ç®—ä¸Šé™ï¼ˆ${Math.round(used/budget*100)}%ï¼‰`);
                }
            },

            getTotalSavedForGoal(goal) {
                // ç°¡å–®ç­–ç•¥ï¼šæŠŠæ‰€æœ‰ income ä¸­ description åŒ…å«ç›®æ¨™åç¨±çš„é‡‘é¡è¦–ç‚ºå·²å„²å­˜
                const username = DataManager.getCurrentUsername();
                if (!username) return 0;
                const users = loadUsers();
                const txs = (users[username] && users[username].transactions) ? users[username].transactions : [];
                const saved = txs.filter(t => t.type === 'income' && (t.description || '').includes(goal.name)).reduce((s,t) => s + Number(t.amount), 0);
                return saved;
            }
        };

        // ---------- åˆå§‹åŒ– ----------
        document.addEventListener('DOMContentLoaded', () => {
            UI.init();
        });

    </script>


<!-- Elfsight AI Chatbot | Untitled AI Chatbot -->
<script src="https://elfsightcdn.com/platform.js" async></script>
<div class="elfsight-app-a6cd8592-eec1-4230-9787-4034858bab00" data-elfsight-app-lazy></div>

</body>
</html>
